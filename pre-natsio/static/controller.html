<html>
  <head>
    <title>Socket.IO Joystick</title>
  </head>
  <body style="background-color: #00AEEF;">
    <center>
      <canvas style="z-index: 999999;" id="video" width="800" height="600"></canvas>
    </center>
    <div id="joystick"/>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
    <script src="./nipplejs.js"></script>
    <script>
        var joystick = nipplejs.create({
            zone: document.getElementById('joystick'),
            mode: 'static',
            position: {left: '50%', top: '75%'},
            color: 'white',
            size: Math.round(0.5 * Math.min(window.innerWidth, window.innerHeight))
        });
        var socket = io();
        function command(cmd) {
            socket.binary(false).emit('command', cmd);
        }
        var frame = new Image();
        var frameUrl;
        var canvas = document.getElementById('video');
        canvas.height = Math.round(0.5 * window.innerHeight);
        canvas.width = window.innerWidth - 20;
        var video = canvas.getContext('2d');
        frame.onload = function () {
          var widthRation = canvas.width / frame.width;
          var heigthRation = canvas.height / frame.height;
          var ration = Math.min(widthRation, heigthRation);
          video.drawImage(frame, 0, 0, ration * frame.width, ration * frame.height);
          (URL || webkitURL).revokeObjectURL(url); // release memory
        };
        // thanks to https://stackoverflow.com/questions/30120250/draw-jpeg-array-directly-onto-a-canvas
        socket.on('video', function(bytes) {
          var blob = new Blob([bytes], {type: "image/jpeg"});
          url = (URL || webkitURL).createObjectURL(blob);
          frame.src = url;
        });
        joystick.on('end', function() { command('stop'); });
        joystick.on('dir:up', function() { command('foreward'); });
        joystick.on('dir:left', function() { command('left'); });
        joystick.on('dir:right', function() { command('right'); });
        joystick.on('dir:down', function() { command('backward'); });
    </script>
  </body>
</html>
